# scorpio-pipe — руководство пользователя (release v4.2)

Пайплайн для первичной редукции длиннощелевых данных SCORPIO (BTA). Проект в активной разработке, но текущая версия уже закрывает:

1) инспекцию ночи (классификацию кадров по FITS-заголовкам),
2) автогенерацию конфигурации под конкретный объект и setup,
3) построение `superbias`,
4) построение `superneon` и автодетекцию кандидатов линий,
5) интерактивную привязку линий (LineID GUI) с сохранением ручных пар,
6) просмотр He–Ne–Ar атласа прямо в окне привязки (кнопка **«Атлас»**).

В корне репозитория лежит файл **HeNeAr_atlas.pdf** (можно заменить своим).

### Что нового в v4.2

- Единый **реестр продуктов** (expected outputs) — используется в QC/UI/CLI.
- **QC report**: `work_dir/report/index.html` + `qc_report.json` с метриками wavesolution/cosmics.
- **Тайминги** каждого шага: `work_dir/report/timings.json`.
- `doit`-задачи корректно поддерживают структуру `wavesol/<disperser>/...`.
- Добавлены простые pytest‑тесты и CI workflow.

---

## Быстрый старт

### 1) Установка

Создай виртуальное окружение и установи проект в editable‑режиме:

```bash
python -m venv .venv

# Windows (PowerShell)
.\.venv\Scripts\Activate.ps1

# Linux/macOS
source .venv/bin/activate

pip install -U pip
pip install -e .

# если хочешь интерактивное окно LineID + встроенный PDF‑атлас:
pip install -e ".[gui]"

# (опционально) SciPy для более качественной автодетекции пиков:
pip install -e ".[science]"
```

### 2) Инспекция данных и автоконфиг

```bash
scorpio-pipe inspect --data-dir /path/to/night
scorpio-pipe run --data-dir /path/to/night --object "NGC2146sat" --work-dir work/ngc2146sat
```

После этого появится:

```
work/ngc2146sat/config.yaml
```

Важный момент: конфиг создаётся **внутри** `work/...`, поэтому в YAML по умолчанию стоит:

```yaml
work_dir: "."
```

Это сделано специально, чтобы избежать путаницы с путями вида `work/.../work/...`.

### 3) Запуск workflow (doit)

Пайплайн использует `doit` (DAG задач). Конфиг можно передать двумя способами.

**Способ A (рекомендуется): через переменную окружения `CONFIG`:**

```bash
# Windows (PowerShell)
$env:CONFIG=(Resolve-Path .\work\ngc2146sat\config.yaml).Path
.\.venv\Scripts\doit.exe -f workflow/dodo.py list
.\.venv\Scripts\doit.exe -f workflow/dodo.py lineid_prepare
```

**Способ B: через параметр `config=...` в doit:**

```bash
.\.venv\Scripts\doit.exe -f workflow/dodo.py config=work/ngc2146sat/config.yaml lineid_prepare
```

Команда `lineid_prepare` автоматически прогонит необходимые зависимости (например `superbias` и `superneon`) и затем откроет GUI.

---

## Запуск без консоли (UI)

Если установлен набор `.[gui]`, можно запускать пайплайн через небольшое окно‑лаунчер **без консоли**.

После установки проекта в venv появится файл:

```text
.venv\Scripts\scorpipe.exe
```

Его можно запускать двойным кликом — это **gui‑script**, поэтому окно терминала не открывается.

В UI сейчас доступны:

- Inspect (поиск FITS и список объектов)
- генерация `config.yaml`
- быстрые параметры для `wavesol` (y_half, пороги)
- запуск ключевых шагов: `manifest`, `superbias`, `superneon`
- открытие LineID GUI (`lineid_prepare`)

### Собрать отдельный `.exe` (PyInstaller)

Если хочется запускать UI вообще без venv, можно собрать отдельный `.exe`.

Из активированного venv (Windows PowerShell):

```powershell
./tools/build_ui_exe.ps1
```

После этого `./scorpipe.exe` можно запускать двойным кликом.

> Для обычных пользователей проще поставить `ScorpioPipe-Setup-x64-<версия>.exe` из GitHub Releases —
> он установит Scorpipe и создаст ярлык.

---

## LineID GUI: привязка линий

Окно состоит из трёх зон:

- **Атлас** (слева, скрыт по умолчанию): открывается кнопкой **«Атлас»**.
- **Профиль супернеона** (по центру): кликом выбираешь ближайший пик.
- **Панель управления** (справа): список λ, ручной ввод, таблица пар.

### Горячие клавиши

- `Enter` — связать выбранный `x₀` с выбранной `λ`
- `Del` — удалить выделенную пару
- `Ctrl+Z` — undo
- `Ctrl+S` — сохранить и закрыть (аналог OK)
- `F11` — полноэкранный режим

### Атлас HeNeAr

1) Нажми **«Атлас»**.
2) Слева появится PDF‑просмотрщик с масштабированием и перелистыванием страниц.
3) Если в конфиге известен `frames.__setup__.disperser`, пайплайн попытается открыть релевантную страницу автоматически.

Встроенный просмотрщик PDF работает в двух режимах:

- **QtPdfWidgets** (если доступен в твоём PySide6) — самый приятный, векторный.
- **PyMuPDF** (pymupdf) — fallback с таким же управлением (Ctrl+колёсико, PgUp/PgDn, drag‑pan), но рендерит страницы в растр.

Чтобы это гарантированно работало, поставь зависимости из `.[gui]`.

---

## Что где лежит (выходные файлы)

Внутри `work/<run>/`:

- `calib/superbias.fits` — объединённый bias
- `wavesol/superneon.fits` — стек неона, выровненный по X, с вычитанием bias (если включено)
- `wavesol/superneon.png` — диагностическая картинка
- `wavesol/peaks_candidates.csv` — кандидаты пиков (x_pix, amp, snr)
- `wavesol/hand_pairs.txt` — ручные пары `x ↔ λ` (итог привязки)

---

## Конфигурация (YAML)

Ниже — параметры, которые чаще всего реально трогают руками.

```yaml
runtime:
  n_jobs: 0                # 0/None = авто (по CPU)

superneon:
  bias_sub: true           # вычитать superbias при сборке супернеона

wavesol:
  profile_y: null          # или [y0, y1] — фиксированная полоса по Y
  y_half: 20               # используется если profile_y: null
  xshift_max_abs: 6        # макс. сдвиг по X при выравнивании кадров

  # автодетекция пиков (в units профиля, через робастный σ)
  peak_snr: 5.0
  peak_prom_snr: 4.0
  peak_distance: 3

  # GUI: авто-порог по амплитуде = median + k*MAD
  gui_min_amp_sigma_k: 5.0
  gui_min_amp: null        # если задать — станет фиксированным

  neon_lines_csv: neon_lines.csv
  atlas_pdf: HeNeAr_atlas.pdf
```

Примечания:

- `work_dir: "."` — рекомендуемый режим (конфиг лежит внутри work‑папки).
- Если хочешь полностью отключить bias‑вычитание для неона: `superneon.bias_sub: false`.

---

## Решение типичных проблем

### 1) `DependencyError ... superbias.fits does not exist`

Причины бывают две:

1) В конфиге пути записаны как `work/<run>/...` при том, что сам `config.yaml` лежит уже в `work/<run>/`.
2) `superneon` в DAG требовал superbias даже когда bias‑вычитание выключено.

В этой версии:

- конфиг‑лоадер аккуратно резолвит `work_dir` и `calib.superbias_path` без дублирования,
- `superneon` делает `task_dep: superbias` **только если** `superneon.bias_sub: true`.

Если ты сидишь на старом `config.yaml`, самый простой фикс:

```yaml
work_dir: "."
calib:
  superbias_path: calib/superbias.fits
```

### 2) GUI не открывается

- Проверь, что установлены зависимости GUI: `PySide6`, `pyqtgraph`.
- Если работаешь на headless‑машине: запускай GUI локально и переноси `hand_pairs.txt` обратно.

### 3) Атлас не показывается внутри окна

Встроенный просмотрщик работает при одном из условий:

- доступен **QtPdfWidgets** (векторный рендер; обеспечивается пакетом `PySide6-Addons`), или
- установлен **PyMuPDF** (`pymupdf`) — тогда страницы рендерятся в растр, но в повышенном DPI,
  чтобы качество было сопоставимо с обычными PDF‑ридерами.

Самый простой вариант — поставить GUI‑зависимости одним шагом:

```bash
pip install -e ".[gui]"
```

### 4) `json.decoder.JSONDecodeError: Extra data` при запуске `doit`

Это почти всегда означает, что повредился файл базы состояния doit (обычно `.doit.db`) — например, если процесс был прерван.

Быстрый фикс:

1) Закрой процессы, которые используют этот репозиторий.
2) Удали `.doit.db` в корне проекта (или в папке, откуда запускаешь `doit`).
3) Запусти команду заново.

Если хочешь полностью изолировать состояние под каждый run, запускай `doit` из `work/<run>/` — тогда `.doit.db` будет лежать рядом с `config.yaml`.

---

## Куда двигаться дальше

Следующие крупные шаги (уже предусмотрены структурой проекта):

- линейризация (λ(x, y) и/или 2D‑мэппинг),
- фит волнового решения по ручным парам,
- LSF/PSF по полю и перенос на sky‑модель,
- sky‑subtraction и извлечение 1D спектра.

Если захочешь — соберём это в один цельный «режим редукции» с профилем логов, прогресс‑баром и полностью воспроизводимой конфигурацией.
