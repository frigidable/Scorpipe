name: Windows Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: windows-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build_check:
    name: build-check
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0 # v5.3.0
        with:
          python-version: "3.12"
          cache: pip

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install build

      - name: Build sdist and wheel
        run: python -m build

      - name: Install wheel and run smoke test
        shell: pwsh
        run: |
          $wheel = Get-ChildItem -Path dist -Filter *.whl | Select-Object -First 1
          if (-not $wheel) { throw "No wheel produced in dist/" }
          python -m pip install "$($wheel.FullName)"
          python -c "import scorpio_pipe; print('scorpio_pipe', getattr(scorpio_pipe, '__version__', 'unknown'))"
          python -m scorpio_pipe --help

  build:
    name: build
    runs-on: windows-latest
    needs: [build_check]
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0 # v5.3.0
        with:
          python-version: "3.12"
          cache: pip

      - name: Resolve build version
        shell: pwsh
        run: |
          $tag = "${{ github.event.release.tag_name }}"
          if ($tag) {
            $ver = $tag.TrimStart('v')
          } else {
            $ver = (python -c "import re, pathlib; p=pathlib.Path('src/scorpio_pipe/version.py'); m=re.search(r"__version__\s*=\s*['\"]([^'\"]+)['\"]", p.read_text(encoding='utf-8')); print(m.group(1) if m else '')").Trim()
          }
          if (-not $ver) { throw "Failed to resolve APP_VERSION" }
          "APP_VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "[Scorpipe] APP_VERSION=$ver" -ForegroundColor DarkCyan


      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup --no-progress -y
          if ($LASTEXITCODE -ne 0) { throw "Failed to install Inno Setup via Chocolatey" }

      - name: Build Windows installer and portable bundle
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File packaging/windows/build.ps1

      - name: Package artifacts + checksums
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release | Out-Null

          $setup = "packaging/windows/Output/ScorpioPipe-Setup-x64-$env:APP_VERSION.exe"
          if (-not (Test-Path $setup)) { throw "Setup EXE not found: $setup" }
          Copy-Item $setup "release/ScorpioPipe-Setup-x64-$env:APP_VERSION.exe" -Force

          if (-not (Test-Path "dist/scorpipe")) { throw "PyInstaller dist not found: dist/scorpipe" }
          Compress-Archive -Path "dist/scorpipe/*" -DestinationPath "release/Scorpipe-Windows-x64-$env:APP_VERSION.zip" -Force

          $out = "release/SHA256SUMS.txt"
          Remove-Item $out -ErrorAction SilentlyContinue
          $files = Get-ChildItem -Path release -File | Where-Object { $_.Name -ne "SHA256SUMS.txt" } | Sort-Object Name
          if (-not $files) { throw "No release files found in release/ for checksum generation" }
          foreach ($f in $files) {
            $h = (Get-FileHash -Algorithm SHA256 $f.FullName).Hash.ToLower()
            "$h  $($f.Name)" | Out-File -FilePath $out -Append -Encoding ascii
          }

      - name: Upload release artifacts
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: windows-release-assets
          path: release/*
          if-no-files-found: error
          retention-days: 7

  publish:
    name: publish
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'release'
    permissions:
      actions: read
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: windows-release-assets
          path: release

      - name: Resolve release version
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ github.event.release.tag_name }}"
          ver="${tag#v}"
          if [ -z "$ver" ]; then
            echo "Failed to resolve APP_VERSION from tag: $tag" >&2
            exit 1
          fi
          echo "APP_VERSION=$ver" >> "$GITHUB_ENV"
          echo "[Scorpipe] APP_VERSION=$ver"


      - name: Detect extra release artifacts (wheel/sdist)
        id: py_dist
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          w=(release/*.whl)
          s=(release/*.tar.gz)
          if [ ${#w[@]} -gt 0 ]; then
            echo "wheel=${w[0]}" >> "$GITHUB_OUTPUT"
            echo "wheel_sbom=${w[0]}.sbom.spdx.json" >> "$GITHUB_OUTPUT"
          fi
          if [ ${#s[@]} -gt 0 ]; then
            echo "sdist=${s[0]}" >> "$GITHUB_OUTPUT"
            echo "sdist_sbom=${s[0]}.sbom.spdx.json" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate SBOM (installer)
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0.21.0
        with:
          file: release/ScorpioPipe-Setup-x64-${{ env.APP_VERSION }}.exe
          format: spdx-json
          output-file: release/ScorpioPipe-Setup-x64-${{ env.APP_VERSION }}.sbom.spdx.json
          upload-artifact: false
          upload-release-assets: false

      - name: Generate SBOM (portable bundle)
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0.21.0
        with:
          file: release/Scorpipe-Windows-x64-${{ env.APP_VERSION }}.zip
          format: spdx-json
          output-file: release/Scorpipe-Windows-x64-${{ env.APP_VERSION }}.sbom.spdx.json
          upload-artifact: false
          upload-release-assets: false

      - name: Generate SBOM (wheel)
        if: ${{ steps.py_dist.outputs.wheel != '' }}
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0.21.0
        with:
          file: ${{ steps.py_dist.outputs.wheel }}
          format: spdx-json
          output-file: ${{ steps.py_dist.outputs.wheel_sbom }}
          upload-artifact: false
          upload-release-assets: false

      - name: Generate SBOM (sdist)
        if: ${{ steps.py_dist.outputs.sdist != '' }}
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0.21.0
        with:
          file: ${{ steps.py_dist.outputs.sdist }}
          format: spdx-json
          output-file: ${{ steps.py_dist.outputs.sdist_sbom }}
          upload-artifact: false
          upload-release-assets: false

      - name: Add SBOMs to checksums
        shell: bash
        run: |
          set -euo pipefail
          cd release
          shopt -s nullglob
          for f in *.sbom.spdx.json; do
            sha256sum "$f" >> SHA256SUMS.txt
          done

      - name: Attest SBOM (installer)
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
        with:
          subject-path: release/ScorpioPipe-Setup-x64-${{ env.APP_VERSION }}.exe
          sbom-path: release/ScorpioPipe-Setup-x64-${{ env.APP_VERSION }}.sbom.spdx.json

      - name: Attest SBOM (portable bundle)
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
        with:
          subject-path: release/Scorpipe-Windows-x64-${{ env.APP_VERSION }}.zip
          sbom-path: release/Scorpipe-Windows-x64-${{ env.APP_VERSION }}.sbom.spdx.json

      - name: Attest SBOM (wheel)
        if: ${{ steps.py_dist.outputs.wheel != '' }}
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
        with:
          subject-path: ${{ steps.py_dist.outputs.wheel }}
          sbom-path: ${{ steps.py_dist.outputs.wheel_sbom }}

      - name: Attest SBOM (sdist)
        if: ${{ steps.py_dist.outputs.sdist != '' }}
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
        with:
          subject-path: ${{ steps.py_dist.outputs.sdist }}
          sbom-path: ${{ steps.py_dist.outputs.sdist_sbom }}

      - name: Attest build provenance
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-checksums: release/SHA256SUMS.txt

      - name: Publish assets to GitHub Release
        uses: softprops/action-gh-release@a06a81a0d0ce0ef6c9f2ce57b1b89e4f563b6993 # v2.5.0
        with:
          files: |
            release/*.exe
            release/*.zip
            release/*.whl
            release/*.tar.gz
            release/*.sbom.spdx.json
            release/SHA256SUMS.txt
