name: windows-release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
      - "*.*"
  release:
    types: [published]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      TAG_NAME: ${{ github.event.release.tag_name || github.ref_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.ref_name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps
        run: |
          python -m pip install -U pip
          pip install -e ".[gui]"
          pip install -U pyinstaller

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Verify Inno Setup (ISCC)
        shell: powershell
        run: |
          $ErrorActionPreference = 'Continue'
          $cmd = (Get-Command ISCC.exe -ErrorAction SilentlyContinue)
          if ($cmd) { Write-Host ('ISCC in PATH: ' + $cmd.Source) -ForegroundColor Cyan } else { Write-Host 'ISCC not in PATH (will fallback to common locations).' -ForegroundColor Yellow }
          $candidates = @()
          if ($env:ProgramFiles -and (Test-Path (Join-Path $env:ProgramFiles 'Inno Setup 6\ISCC.exe'))) { $candidates += (Join-Path $env:ProgramFiles 'Inno Setup 6\ISCC.exe') }
          if (${env:ProgramFiles(x86)} -and (Test-Path (Join-Path ${env:ProgramFiles(x86)} 'Inno Setup 6\ISCC.exe'))) { $candidates += (Join-Path ${env:ProgramFiles(x86)} 'Inno Setup 6\ISCC.exe') }
          if ($candidates.Count -gt 0) { Write-Host ('ISCC candidate: ' + $candidates[0]) -ForegroundColor Cyan }

      - name: Build scorpipe.exe + setup.exe
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $ver = "${env:TAG_NAME}".TrimStart('v')
          Write-Host "Building Scorpipe for version: $ver" -ForegroundColor Cyan
          & .\packaging\windows\build.ps1 -SkipInstall

          if (-not (Test-Path packaging\windows\Output\setup.exe)) {
            throw "setup.exe was not produced. Check Inno Setup / ISCC step logs."
          }

      - name: Package release zip
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path release | Out-Null
          Copy-Item packaging\windows\Output\setup.exe release\setup.exe -Force
          Copy-Item INSTALL.md release\INSTALL.md -Force
          Compress-Archive -Path release\* -DestinationPath Scorpipe-Windows-x64.zip -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Scorpipe-Windows-x64
          path: |
            Scorpipe-Windows-x64.zip
            packaging\windows\Output\setup.exe

      - name: Upload build logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Windows-build-logs
          path: |
            packaging\windows\Output\*.log
            packaging\windows\Output\setup.exe

      - name: Publish GitHub Release assets
        if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          files: |
            Scorpipe-Windows-x64.zip
            packaging\windows\Output\setup.exe
