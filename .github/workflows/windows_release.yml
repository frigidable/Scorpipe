name: Windows Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: windows-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build_check:
    name: build-check
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a72 # v5.3.0
        with:
          python-version: "3.12"
          cache: pip

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install build

      - name: Build sdist and wheel
        run: python -m build

      - name: Install wheel and run smoke test
        shell: pwsh
        run: |
          $wheel = Get-ChildItem -Path dist -Filter *.whl | Select-Object -First 1
          if (-not $wheel) { throw "No wheel produced in dist/" }
          python -m pip install "$($wheel.FullName)"
          python -c "import scorpio_pipe; print('scorpio_pipe', getattr(scorpio_pipe, '__version__', 'unknown'))"
          python -m scorpio_pipe --help

  build:
    name: build
    runs-on: windows-latest
    needs: [build_check]
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a72 # v5.3.0
        with:
          python-version: "3.12"
          cache: pip

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup --no-progress -y
          if ($LASTEXITCODE -ne 0) { throw "Failed to install Inno Setup via Chocolatey" }

      - name: Build Windows installer and portable bundle
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File packaging/windows/build.ps1

      - name: Package artifacts + checksums
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release | Out-Null

          $setup = "packaging/windows/Output/ScorpioPipe-Setup-x64.exe"
          if (-not (Test-Path $setup)) { throw "Setup EXE not found: $setup" }
          Copy-Item $setup "release/ScorpioPipe-Setup-x64.exe" -Force

          if (-not (Test-Path "dist/scorpipe")) { throw "PyInstaller dist not found: dist/scorpipe" }
          Compress-Archive -Path "dist/scorpipe/*" -DestinationPath "release/Scorpipe-Windows-x64.zip" -Force

          $files = @("release/ScorpioPipe-Setup-x64.exe","release/Scorpipe-Windows-x64.zip")
          $out = "release/SHA256SUMS.txt"
          Remove-Item $out -ErrorAction SilentlyContinue
          foreach ($f in $files) {
            $h = (Get-FileHash -Algorithm SHA256 $f).Hash.ToLower()
            $n = Split-Path -Leaf $f
            "$h  $n" | Out-File -FilePath $out -Append -Encoding ascii
          }

      - name: Upload release artifacts
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: windows-release-assets
          path: release/*
          if-no-files-found: error
          retention-days: 7

  publish:
    name: publish
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'release'
    permissions:
      actions: read
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: windows-release-assets
          path: release

      - name: Generate SBOM (portable bundle)
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0.21.0
        with:
          file: release/Scorpipe-Windows-x64.zip
          format: spdx-json
          output-file: release/Scorpipe-Windows-x64.sbom.spdx.json
          upload-artifact: false
          upload-release-assets: false

      - name: Add SBOM to checksums
        shell: bash
        run: |
          cd release
          sha256sum Scorpipe-Windows-x64.sbom.spdx.json >> SHA256SUMS.txt

      - name: Attest SBOM
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
        with:
          subject-path: release/Scorpipe-Windows-x64.zip
          sbom-path: release/Scorpipe-Windows-x64.sbom.spdx.json

      - name: Attest build provenance
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-checksums: release/SHA256SUMS.txt

      - name: Publish assets to GitHub Release
        uses: softprops/action-gh-release@a06a81a0d0ce0ef6c9f2ce57b1b89e4f563b6993 # v2.5.0
        with:
          files: |
            release/ScorpioPipe-Setup-x64.exe
            release/Scorpipe-Windows-x64.zip
            release/Scorpipe-Windows-x64.sbom.spdx.json
            release/SHA256SUMS.txt
