name: CodeQL

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  schedule:
    - cron: "23 3 * * 1"

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  analyze:
    name: analyze
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: ["python"]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Decide whether to run CodeQL
        id: decide
        shell: bash
        run: |
          # Keep the required check fast for docs/metadata-only PRs.
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          # Ensure the base/head SHAs exist locally (best-effort).
          git fetch --no-tags --prune --depth=1 origin "$BASE" "$HEAD" || true

          files="$(git diff --name-only "$BASE" "$HEAD" || true)"
          echo "Changed files:"
          echo "$files"

          run=false
          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            case "$f" in
              .github/*|docs/*|LICENSE|CITATION.cff|CHANGELOG.md|INSTALL.md|CONTRIBUTING.md|SECURITY.md|*.md)
                ;;
              *)
                run=true
                break
                ;;
            esac
          done <<< "$files"

          echo "run=$run" >> "$GITHUB_OUTPUT"

      - name: Initialize CodeQL
        if: steps.decide.outputs.run == 'true'
        uses: github/codeql-action/init@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10
        with:
          languages: ${{ matrix.language }}

      - name: Analyze
        if: steps.decide.outputs.run == 'true'
        uses: github/codeql-action/analyze@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10
