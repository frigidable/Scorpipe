name: Dependabot auto-approve & auto-merge

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: dependabot-automerge-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  dependabot:
    if: >-
      github.event.pull_request.user.login == 'dependabot[bot]' &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest

    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@21025c705c08248db411dc16f3619e6b5f9ea21a
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Approve patch/minor PR
        if: >-
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge (SQUASH) for patch/minor PR
        if: >-
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          set -euo pipefail

          # If auto-merge is disabled in repo settings, this will fail; keep the workflow green.
          PR_NODE_ID=$(gh pr view "$PR_URL" --json id --jq .id)

                    QUERY=$(cat <<'GRAPHQL'
          mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
            enablePullRequestAutoMerge(input: {pullRequestId: $pullRequestId, mergeMethod: $mergeMethod}) {
              pullRequest { number }
            }
          }
          GRAPHQL
          )

          gh api graphql \
            -f query="$QUERY" \
            -f pullRequestId="$PR_NODE_ID" \
            -f mergeMethod="SQUASH" \
            || {
              echo "::warning::Could not enable auto-merge. Ensure 'Allow auto-merge' is enabled in repository settings.";
              exit 0;
            }
env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
