name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  meta_validate:
    name: meta_validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate .github/dependabot.yml parses as YAML and has 2 update blocks
        run: |
          python -m pip install --upgrade pip pyyaml
          python - <<'PY'
          from pathlib import Path
          import yaml

          p = Path(".github/dependabot.yml")
          data = yaml.safe_load(p.read_text(encoding="utf-8"))
          updates = data.get("updates")
          assert isinstance(updates, list), "dependabot.yml: 'updates' must be a list"
          assert len(updates) == 2, f"dependabot.yml: expected 2 update blocks, got {len(updates)}"
          ecos = [u.get("package-ecosystem") for u in updates]
          assert set(ecos) == {"github-actions", "pip"}, f"dependabot.yml: unexpected ecosystems {ecos}"
          print("OK: dependabot.yml parses and looks sane:", ecos)
          PY

      - name: Install actionlint
        run: |
          go version
          go install github.com/rhysd/actionlint/cmd/actionlint@v1.7.9
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: actionlint (.github/workflows/*.yml)
        run: actionlint -color

  tests:
    name: tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      - name: Install package + test deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .
          python -m pip install pytest

      - name: Run tests
        run: pytest -q

  build_check:
    name: build_check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      - name: Build (sdist/wheel)
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Install from wheel + smoke test
        run: |
          python -m pip install --upgrade pip
          python -m pip install dist/*.whl
          python -c "import scorpio_pipe; print('scorpio_pipe version:', getattr(scorpio_pipe, '__version__', 'unknown'))"
          scorpio-pipe --help

  dependency_review:
    name: dependency_review
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2 (tag v4)

  pr_title:
    name: pr_title
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: read
    steps:
      - name: Validate PR title follows Conventional Commits
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

  gate:
    name: gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    needs:
      - meta_validate
      - tests
      - build_check
      - pr_title
      - dependency_review
    steps:
      - name: Summarize required jobs
        env:
          NEEDS_JSON: ${{ toJson(needs) }}
        run: |
          python - <<'PY'
          import json, os, sys
          needs = json.loads(os.environ["NEEDS_JSON"])
          # dependency_review may be "skipped" on push events; that's OK.
          allow_skipped = {"dependency_review", "pr_title"}
          bad = []
          for job_id, meta in needs.items():
            res = meta.get("result")
            if res == "success":
              continue
            if res == "skipped" and job_id in allow_skipped:
              continue
            bad.append(f"{job_id}={res}")
          if bad:
            print("Blocking merge: required CI jobs not successful:", ", ".join(bad))
            sys.exit(1)
          print("OK: all required CI jobs are green.")
          PY
